<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mango Meter</title>

<style>
@keyframes rgb-cycle {
  0% { color:red; border-color:red; box-shadow:0 0 15px red; }
  33% { color:lime; border-color:lime; box-shadow:0 0 15px lime; }
  66% { color:blue; border-color:blue; box-shadow:0 0 15px blue; }
  100% { color:red; border-color:red; box-shadow:0 0 15px red; }
}

body {
  margin:0;
  background:black;
  font-family:Courier New, monospace;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
  overflow:hidden;
}

.settings-btn {
  position:fixed;
  top:20px;
  right:20px;
  background:none;
  border:2px solid white;
  color:white;
  padding:10px;
  cursor:pointer;
}

#settings {
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:black;
  border:3px solid white;
  border-radius:15px;
  padding:20px;
  width:80%;
  z-index:99;
}

#gauge {
  width:300px;
  height:150px;
  border:4px solid #555;
  border-radius:150px 150px 0 0;
  position:relative;
  margin:20px 0;
}

#needle {
  position:absolute;
  bottom:0;
  left:50%;
  width:5px;
  height:130px;
  background:red;
  transform-origin:bottom;
  transform:rotate(-90deg);
  transition:0.1s;
}

#char {
  width:150px;
  height:150px;
  border-radius:50%;
  border:5px solid white;
  animation:rgb-cycle 3s linear infinite;
}

.active {
  animation:shake 0.05s infinite;
}
@keyframes shake {
  0%{transform:scale(1.1) translate(2px,2px)}
  50%{transform:scale(1.1) translate(-2px,-2px)}
}

#sliderWrap {
  width:100%;
  margin-top:10px;
  animation:rgb-cycle 2s linear infinite;
}

#slider {
  width:100%;
  height:50px;
  touch-action:none;
}

#notice {
  position:fixed;
  bottom:10px;
  font-size:12px;
  color:#777;
}
</style>
</head>

<body>

<button class="settings-btn" onclick="toggleSettings()">⚙</button>

<div id="settings">
  <h3>Sensitivity</h3>
  <input type="range" id="sens" min="10" max="200" value="50" style="width:100%">
  <hr>

  <h3>Audio Boost</h3>
  <div id="sliderWrap">
    <canvas id="slider"></canvas>
  </div>
  <p id="volText" style="text-align:center">Volume: 1.00x</p>

  <hr>
  <h3>Jolly Mode</h3>
  <input type="checkbox" id="jolly" onchange="toggleJolly()" style="transform:scale(2)">
</div>

<div id="mag">0 μT</div>

<div id="gauge">
  <div id="needle"></div>
</div>

<img id="char" src="lebron.png">

<button onclick="start()" style="padding:15px;margin-top:10px">ENABLE SENSOR</button>

<div id="notice"></div>

<audio id="s1" src="lebronscream.mp3"></audio>
<audio id="s2" src="why-so-jolly-made-with-Voicemod.mp3"></audio>

<script>
let audioCtx, gainNode;
let volume = 100;
let active = false;

const canvas = document.getElementById("slider");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function toggleSettings(){
  settings.style.display = settings.style.display==="block"?"none":"block";
}

function toggleJolly(){
  char.src = jolly.checked ? "whysojolly.jpg" : "lebron.png";
}

function start(){
  if(!audioCtx){
    audioCtx = new AudioContext();
    gainNode = audioCtx.createGain();
    gainNode.connect(audioCtx.destination);
    audioCtx.createMediaElementSource(s1).connect(gainNode);
    audioCtx.createMediaElementSource(s2).connect(gainNode);
  }

  if("Magnetometer" in window){
    const m = new Magnetometer({frequency:60});
    m.addEventListener("reading",()=>{
      const v = Math.sqrt(m.x*m.x + m.y*m.y + m.z*m.z);
      update(v);
    });
    m.start();
  } else {
    notice.innerText = "⚠️ Magnetic sensor not detected on this device.";
  }
}

function update(v){
  mag.innerText = Math.floor(v)+" μT";
  let limit = sens.value;
  let angle = (v/limit)*180 - 90;
  angle = Math.max(-90,Math.min(90,angle));
  needle.style.transform = `rotate(${angle}deg)`;

  if(v>limit && !active){
    active = true;
    gainNode.gain.value = volume/100;
    const snd = jolly.checked ? s2 : s1;
    snd.currentTime=0;
    snd.play();
    char.classList.add("active");
  }
  if(v<limit-10){
    active=false;
    char.classList.remove("active");
  }
}

/* ===== WORKING RGB JEL SLIDER ===== */
function drawSlider(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const t = Date.now()/500;
  ctx.strokeStyle = `rgb(
    ${128+127*Math.sin(t)},
    ${128+127*Math.sin(t+2)},
    ${128+127*Math.sin(t+4)}
  )`;
  ctx.lineWidth = 10;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(10,canvas.height/2);
  ctx.lineTo(10 + (volume/1000)*(canvas.width-20),canvas.height/2);
  ctx.stroke();
  requestAnimationFrame(drawSlider);
}
drawSlider();

function setVolumeFromEvent(e){
  const rect = canvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  volume = Math.max(0,Math.min(1000,(x/rect.width)*1000));
  volText.innerText = "Volume: " + (volume/100).toFixed(2) + "x";
}

canvas.addEventListener("mousedown",e=>{
  setVolumeFromEvent(e);
  window.onmousemove = setVolumeFromEvent;
  window.onmouseup = ()=>window.onmousemove=null;
});
canvas.addEventListener("touchstart",setVolumeFromEvent);
canvas.addEventListener("touchmove",setVolumeFromEvent);
</script>

</body>
</html>
